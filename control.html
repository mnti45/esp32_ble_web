<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ESP32 BLE Control</title>
</head>
<body>
<h2>ESP32 BLE Web Control</h2>
<input type="text" id="msg" placeholder="Nhập dữ liệu...">
<button onclick="sendData()">Gửi</button>
<p id="status">Chưa kết nối</p>

<script>
let bleDevice;
let bleServer;
let bleService;
let bleCharacteristic;

// UUID của ESP32 (giống code bạn)
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

// Hàm tự động kết nối khi mở trang
async function connectESP32() {
    try {
        document.getElementById("status").innerText = "Đang quét thiết bị...";
        bleDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [SERVICE_UUID]
        });

        document.getElementById("status").innerText = "Đang kết nối...";
        bleServer = await bleDevice.gatt.connect();

        bleService = await bleServer.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await bleService.getCharacteristic(CHARACTERISTIC_UUID);

        document.getElementById("status").innerText = "✅ Đã kết nối với " + bleDevice.name;

    } catch (error) {
        document.getElementById("status").innerText = "❌ Lỗi: " + error;
        console.error(error);
    }
}

// Gửi dữ liệu vào ESP32
async function sendData() {
    if (!bleCharacteristic) {
        alert("Chưa kết nối ESP32!");
        return;
    }
    let text = document.getElementById("msg").value;
    if (!text) return;
    let encoder = new TextEncoder();
    await bleCharacteristic.writeValue(encoder.encode(text));
    console.log("Đã gửi: " + text);
}

connectESP32(); // Gọi ngay khi mở trang
</script>
</body>
</html>
